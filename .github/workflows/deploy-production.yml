# .github/workflows/deploy-production.yml
name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:  # Manual trigger

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: SAST Scan
        uses: github/codeql-action/init@v2
        with:
          languages: python, javascript
      
      - name: Dependency Vulnerability Scan
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      
      - name: Secret Scanning
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --regex --entropy=False

  build-and-test:
    runs-on: ubuntu-latest
    needs: security-scan
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to AWS ECR
        uses: aws-actions/amazon-ecr-login@v1
      
      - name: Build and push backend
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile.backend
          push: true
          tags: |
            ${{ secrets.AWS_ECR_REGISTRY }}/backend:latest
            ${{ secrets.AWS_ECR_REGISTRY }}/backend:${{ github.sha }}
          cache-from: type=registry,ref=${{ secrets.AWS_ECR_REGISTRY }}/backend:buildcache
          cache-to: type=registry,ref=${{ secrets.AWS_ECR_REGISTRY }}/backend:buildcache,mode=max
      
      - name: Run integration tests
        run: |
          docker-compose -f docker-compose.test.yml up --abort-on-container-exit
        env:
          DATABASE_URL: postgresql://test:test@localhost/test
          REDIS_URL: redis://localhost:6379

  deploy-infrastructure:
    runs-on: ubuntu-latest
    needs: build-and-test
    environment: production
    steps:
      - uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0
      
      - name: Terraform Init
        run: terraform init -backend-config="bucket=talentmatch-terraform-state"
        working-directory: ./infrastructure/terraform/production
      
      - name: Terraform Plan
        run: terraform plan -out=tfplan
        working-directory: ./infrastructure/terraform/production
      
      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan
        working-directory: ./infrastructure/terraform/production
        env:
          TF_VAR_google_client_id: ${{ secrets.GOOGLE_CLIENT_ID }}
          TF_VAR_google_client_secret: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}

  deploy-application:
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    environment: production
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
      
      - name: Update ECS Service
        run: |
          aws ecs update-service \
            --cluster talentmatch-backend \
            --service backend \
            --force-new-deployment \
            --region us-east-1
      
      - name: Wait for deployment
        run: |
          aws ecs wait services-stable \
            --cluster talentmatch-backend \
            --services backend \
            --region us-east-1
      
      - name: Run smoke tests
        run: |
          ./scripts/smoke-test.sh https://api.talentmatch.com
      
      - name: Notify deployment
        if: success()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_COLOR: good
          SLACK_TITLE: "âœ… Production Deployment Successful"
          SLACK_MESSAGE: "TalentMatch v${{ github.sha }} deployed to production"
